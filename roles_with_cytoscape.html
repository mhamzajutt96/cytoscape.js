<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snowflake security roles visualization</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.18.2/cytoscape.min.js"
          integrity="sha512-CBGCXtszkG5rYlQSTNUzk54/731Kz28WPk2uT1GCPCqgfVRJ2v514vzzf16HuGX9WVtE7JLqRuAERNAzFZ9Hpw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>

<style>
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
    padding: 12px 16px;
    z-index: 1;
  }

  .search-box {
    float: right;
  }

  #search-field-graph {
    width: 500px;
    padding: 12px 20px;
    margin-bottom: 8px;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }

  .Hamza {
    fill: #0b0b0b !important;
    stroke: #0ae6c5 !important;;
  }

  .White-text {
    fill: white !important;
  }

  #cy {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 200px;
    left: 0px;
  }
</style>

<!--Dropdown-->

<div class="dropdown">
  <h3>Select JSON File</h3>
  <select class="dropdown-content"></select>
</div>

<!--Search Field-->

<div class="search-box">
  <h3>Search Graph Nodes</h3>
  <input type="text" id="search-field-graph" placeholder="Enter your favourite nodes...">
</div>

<!--Graph Container-->

<div class="container">
<!--  <svg width=24000 height=10000>-->
<!--    <g/>-->
<!--  </svg>-->
</div>

<!--Script handling the dropdown change-->

<script>
  $(document).ready(function () {

    // Script for dropdown

    // Adding file names to dropdown list
    const files = [];
    files.push('data/hia_data.json')
    files.push('data/snowflake_data.json')

    for (let i = 0; i < files.length; i++) {
      $('.dropdown-content').append(`<option class=${files[i]}>` + files[i] + '</option>');
    }

    // Changing JSON file using select option
    $('.dropdown-content').on('change', function () {
      data_file_url = $('.dropdown-content').val()
      window.location.href = `roles_with_dagre.html?json_file=${data_file_url}`
    })

    // Getting URL and filename
    let params = new window.URLSearchParams(window.location.search);
    if (params.has('json_file')) {
      $('.dropdown-content').val(params.get('json_file'))
    }

  })
</script>


<div id="cy"></div>
<!--Graph Script-->

<script>

  var cy = (window.cy = cytoscape({
    container: document.getElementById("cy"),

    style: [{
      selector: "node",
      css: {
        content: "data(id)",
        "text-valign": "center",
        "text-halign": "center",
        height: "60px",
        width: "60px",
        "border-color": "black",
        "border-opacity": "1",
        "border-width": "10px"
      }
    },
      {
        selector: "edge",
        css: {
          "target-arrow-shape": "triangle"
        }
      }
    ],

    elements: {
      nodes: [{
        data: {
          id: "n0"
        }
      },
        {
          data: {
            id: "n1"
          }
        },
        {
          data: {
            id: "n2"
          }
        },
        {
          data: {
            id: "n3"
          }
        },
        {
          data: {
            id: "n4"
          }
        },
        {
          data: {
            id: "n5"
          }
        },
        {
          data: {
            id: "n6"
          }
        },
        {
          data: {
            id: "n7"
          }
        },
        {
          data: {
            id: "n8"
          }
        },
        {
          data: {
            id: "n9"
          }
        },
        {
          data: {
            id: "n10"
          }
        },
        {
          data: {
            id: "n11"
          }
        },
        {
          data: {
            id: "n12"
          }
        },
        {
          data: {
            id: "n13"
          }
        },
        {
          data: {
            id: "n14"
          }
        },
        {
          data: {
            id: "n15"
          }
        },
        {
          data: {
            id: "n16"
          }
        }
      ],
      edges: [{
        data: {
          source: "n0",
          target: "n1"
        }
      },
        {
          data: {
            source: "n1",
            target: "n2"
          }
        },
        {
          data: {
            source: "n1",
            target: "n3"
          }
        },
        {
          data: {
            source: "n4",
            target: "n5"
          }
        },
        {
          data: {
            source: "n4",
            target: "n6"
          }
        },
        {
          data: {
            source: "n6",
            target: "n7"
          }
        },
        {
          data: {
            source: "n6",
            target: "n8"
          }
        },
        {
          data: {
            source: "n8",
            target: "n9"
          }
        },
        {
          data: {
            source: "n8",
            target: "n10"
          }
        },
        {
          data: {
            source: "n11",
            target: "n12"
          }
        },
        {
          data: {
            source: "n12",
            target: "n13"
          }
        },
        {
          data: {
            source: "n13",
            target: "n14"
          }
        },
        {
          data: {
            source: "n13",
            target: "n15"
          }
        }
      ]
    },

    layout: {
      name: "dagre",
      padding: 5
    }
  }));


  cy.unbind('click')
  cy.bind('click', 'node', function(event) {
    // .union() takes two collections and adds both together without duplicates
    var connected = event.target
    connected = connected.union(event.target.predecessors())
    connected = connected.union(connected.successors())
    // in one line:
    // event.target.union(event.target.predecessors().union(event.target.successors()))

    // .not() filters out whatever is not specified in connected, e.g. every other node/edge not present in connected
    var notConnected = cy.elements().not(connected)

    // if you want, you can later add the saved elements again
    var saved = cy.remove(notConnected)
  });

  // data_file_url = 'data/hia_data.json'

  // let cy = cytoscape({
  //   container: $('#cy'),
  //   style: [
  //     {
  //       selector: 'node',
  //       style: {
  //         'background-color': '#666',
  //         'label': 'data(GRANTEE_NAME)'
  //       }
  //     },
  //     {
  //       selector: 'edge',
  //       style: {
  //         'width': 3,
  //         'line-color': '#ccc',
  //         'target-arrow-color': '#ccc',
  //         'target-arrow-shape': 'triangle',
  //         'curve-style': 'bezier',
  //         'label': 'data(PRIVILEGE)'
  //       }
  //     }
  //   ],
  //   layout: {
  //     name: 'breadthfirst',
  //   }
  // })

  // $.get(data_file_url, function (data) {
  //   for (let i = 0; i < data.length; i++) {
  //     let jsonObject = data[i]
  //     cy.add([
  //       {
  //         group: "nodes",
  //         data: {
  //           id: jsonObject.GRANTEE_NAME,
  //           GRANTEE_NAME: jsonObject.GRANTEE_NAME
  //         },
  //         position: {
  //           x: i * 100,
  //           y: i * 100
  //         }
  //       },
  //     ])
  //     cy.add([
  //       {
  //         group: "nodes",
  //         data: {
  //           id: jsonObject.NAME,
  //           NAME: jsonObject.NAME
  //         },
  //         // style: [
  //         //   {
  //         //     selector: 'node',
  //         //     style: {
  //         //       'background-color': '#666',
  //         //       'label': jsonObject.NAME
  //         //     }
  //         //   },
  //         //   {
  //         //     selector: 'edge',
  //         //     style: {
  //         //       'width': 3,
  //         //       'line-color': '#ccc',
  //         //       'target-arrow-color': '#ccc',
  //         //       'target-arrow-shape': 'triangle',
  //         //       'curve-style': 'bezier',
  //         //       'label': 'data(PRIVILEGE)'
  //         //     }
  //         //   }
  //         // ],
  //         position: {
  //           x: i * 100,
  //           y: i * 100
  //         }
  //       },
  //     ])
  //
  //     cy.add([
  //       {
  //         group: "edges",
  //         data: {
  //           source: jsonObject.NAME,
  //           target: jsonObject.GRANTEE_NAME,
  //           PRIVILEGE: jsonObject.PRIVILEGE
  //         }
  //       }
  //     ])
  //   }
  // })

</script>

<!--Script for Searching-->

<script>
  $(document).ready(function () {
    $('#search-field-graph').on('keyup', function () {
      let searchFieldValue = $('#search-field-graph').val()
      $('.nodes').each(function () {
        let allNodesText = $(this).children('g').children('g').children('g').children('text').children('tspan')
        let totalNodesLength = allNodesText.length
        for (let i = 0; i < totalNodesLength; i++) {
          let specificNodeBox = $(this).children('g').children('rect')[i]
          let specificTSpan = allNodesText.get(i)
          if ($(specificTSpan).text().indexOf(searchFieldValue) > -1) {
            $(specificNodeBox).addClass("Hamza")
            $(allNodesText[i]).addClass("White-text")
          } else {
            $(specificNodeBox).removeClass("Hamza")
            $(allNodesText[i]).removeClass("White-text")
          }
        }
      })
    })
    $('#search-field-graph').on('change keyup', function () {
      let searchFieldValue = $('#search-field-graph').val()
      if (searchFieldValue === '') {
        $('.Hamza').removeClass("Hamza")
        $('.White-text').removeClass("White-text")
      }
    })
  })
</script>

</body>
</html>
