<!DOCTYPE html>

<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Snowflake security roles visualization</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.1.0/cytoscape-dagre.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>

  <body>
    <style>
      body {
        font: 14px helvetica neue, helvetica, arial, sans-serif;
      }
      #cy {
        height: 100%;
        width: 100%;
        position: absolute;
        left: 0;
        top: 0;
        float: left;
      }
    </style>

    <div id="cy"></div>
  </body>

  <script>

    data_file_url = 'data/hia_data.json'

    let cy = (window.cy = cytoscape({
      container: document.getElementById("cy"),

      style: [
        {
          selector: "node",
          css: {
            content: "data(id)",
            "text-valign": "center",
            "text-halign": "center",
            height: "100px",
            width: "250px",
            "border-color": "black",
            "border-opacity": "1",
            "border-width": "1px",
            shape: "octagon"
          }
        },
        {
          selector: "edge",
          css: {
            content: "data(privilege)",
            width: 3,
            "line-color": "#cef9b6",
            "target-arrow-color": "#f50909",
            "target-arrow-shape": "triangle",
            "curve-style": "bezier"
          }
        }
      ],

      layout: {
        name: "dagre",
        padding: 5
      }
    }));

    cy.add({ group: 'nodes', data: { id: 'Roles' } });
    cy.add({ group: 'nodes', data: { id: 'Users' } });

    cy.add({ group: 'nodes', data: { id: 'n1', parent: 'Roles' }})
    cy.add({ group: 'nodes', data: { id: 'n2', parent: 'Roles' }})
    cy.add({ group: 'nodes', data: { id: 'n3', parent: 'Roles' }})

    cy.add({ group: 'edges', data: { id: 'e1', source: 'n1', target: 'n2' }})
    cy.add({ group: 'edges', data: { id: 'e2', source: 'n3', target: 'n2' }})

    // $.get(data_file_url, function (data) {
    //   for ( let i = 0; i < data.length; i++) {
    //     if (cy.filter(`node[id = "${data[i].GRANTEE_NAME}"]`).length > 0) {
    //       continue
    //     }
    //     cy.add({
    //       group: 'nodes',
    //       data: {
    //         id: data[i].GRANTEE_NAME,
    //         // parent: 'Roles'
    //       },
    //       position: { x: i * 100, y: i * 100 }
    //     });
    //   }
    // })
    //
    // $.get(data_file_url, function (data) {
    //   for ( let i = 0; i < data.length; i++) {
    //     if (cy.filter(`node[id = "${data[i].NAME}"]`).length > 0) {
    //       continue
    //     }
    //     cy.add({
    //       group: 'nodes',
    //       data: {
    //         id: data[i].NAME,
    //         // parent: 'Users'
    //       },
    //       position: { x: i * 100, y: i * 100 }
    //     });
    //   }
    // })
    //
    // $.get(data_file_url, function (data) {
    //   for ( let i = 0; i < data.length; i++) {
    //     cy.add({
    //       group: 'edges',
    //       data: {
    //         source: data[i].NAME,
    //         target: data[i].GRANTEE_NAME,
    //         privilege: data[i].PRIVILEGE
    //       }
    //     });
    //   }
    // })

    cy.unbind('click')
    cy.bind('click', 'node', function(event) {
      // .union() takes two collections and adds both together without duplicates
      let connected = event.target

      connected = connected.union(event.target.predecessors())
      connected = connected.union(connected.successors())
      connected = connected.union(connected.parent())
      //
      // // in one line:
      // // event.target.union(event.target.predecessors().union(event.target.successors()))
      //
      // // .not() filters out whatever is not specified in connected, e.g. every other node/edge not present in connected
      // console.log(cy.elements().not(connected))
      let notConnected = cy.elements().not(connected)
      //
      // // if you want, you can later add the saved elements again
      let saved = cy.remove(notConnected)
    });

  </script>

</html>
